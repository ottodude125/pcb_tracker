<% if @posting_new_thread %>  <% action = { :action => 'deliver_thread_mail' } %><% else %>  <% action = { :action => 'show', :id => @ipd_post.id } %><% end %><% form_tag(action) do %><%= hidden_field("ipd_post", "id") %><p align="center">  <b>Note:</b><br />  <% if @posting_new_thread %>    This screen allows you to add people to the CC list.    The thread has been created, but no mail will    sent until you click the 'Send Email' button below.  <% else %>    This screen allows you to modify the CC list.  Any changes made    here will be reflected the next time the thread is updated and    an email is sent.  <% end %></p><table width="100%" border='0'>  <tr><td colspan="2"><hr class='div' /></td></tr>  <tr>    <th rowspan="2" width="100" align='right' valign='top'>      Thread:    </th>    <td><b><%= @ipd_post.subject %></b></td>  </tr>  <tr>    <td>      <%= @ipd_post.body %>    </td>  </tr></table><table width="100%" border='0'>  <tr><td colspan="2"><hr class='div' /></td></tr>  <tr>    <th colspan="2" align="left">Mail Recipients</th>  </tr>  <% if @associated_users[:designer] %>    <tr>      <th width="500" align="right">Designer: </th>      <td><%= @associated_users[:designer].name %></td>    </tr>  <% end %>  <% if @associated_users['HWENG'] %>    <tr>      <th width="500" align="right">Hardware Engineer: </th>      <td><%= @associated_users['HWENG'].name %></td>    </tr>  <% end %>  <tr><td colspan="2"><hr class='div' /></td></tr>  <tr>    <th colspan="2" align="left">CC List (Mandatory)</th>  </tr>  <tr>    <th width="500" align="right">Hardware Engineering Manager: </th>    <td><%= @associated_users['Hardware Engineering Manager'].name %></td>  </tr>  <% for input_gate in @input_gate_list %>    <tr>      <th align="right">PCB Input Gate: </th>      <td><%= input_gate.name %></td>    </tr>  <% end %>  <% for pcb_manager in @manager_list %>    <tr>      <th align="right">PCB Design Manager: </th>      <td><%= pcb_manager.name %></td>    </tr>  <% end %>    <tr><td colspan="2"><hr class='div' /></td></tr></table><div id="selections"><table width="100%" border='0'>  <tr>    <th colspan="2" align="left">CC List (Optional)</th>  </tr>    <tr>    <td colspan="2">      <% ranges = split_into_cols(@optional_cc_list, 3) %>      <table width="90%" align="center">        <tr>          <% if not ranges[1][:empty] %>            <td valign="top" width="33%">              <table>                <% for user in @optional_cc_list[ranges[1][:start]..ranges[1][:stop]] %>                  <tr><td><%= user.name %></td></tr>			    <% end %>              </table>            </td>          <% else %>            <td>&nbsp;</td>          <% end %>          <% if not ranges[2][:empty] %>            <td valign="top" width="33%">              <table>                <% for user in @optional_cc_list[ranges[2][:start]..ranges[2][:stop]] %>                  <tr><td><%= user.name %></td></tr>			    <% end %>              </table>            </td>          <% else %>            <td>&nbsp;</td>          <% end %>          <% if not ranges[3][:empty] %>            <td valign="top" width="33%">              <table>                <% for user in @optional_cc_list[ranges[3][:start]..ranges[3][:stop]] %>                  <tr><td><%= user.name %></td></tr>			    <% end %>              </table>            </td>          <% else %>            <td>&nbsp;</td>          <% end %>        </tr>      </table>    </td>  </tr>    <tr>    <td colspan="2">      <table>        <tr>          <td width="50%" align="center">                <% if @available_to_cc.size > 0 %>              <table>                <tr>                  <td width="50%" align="center">                    <font size="-2">                      To add a user to the CC list for the thread, click on the person's name.                    </font>                  </td>                </tr>                <tr>                  <td align="center">                    <%= collection_select(                          :add,                          :name,                          @available_to_cc,                          :id,                          :name,                          {:include_blank => true},                          "class" => 'name_select',                          "size"  => '10') %>                    <%= observe_field(                          'add_name',                          :update => 'selections',                          :url    => {:action => 'add_to_thread_list'},                          :with   => "'id=' + escape(value)") %>                  </td>                </tr>              </table>            <% else %>              No users remain to be added.            <% end %>          </td>          <td width="50%" align="center">                <% if @optional_cc_list.size > 0 %>              <table>                <tr>                  <td width="50%" align="center">                    <font size="-2">                      To remove a user from the CC list for the thread, click on the person's name.                    </font>                  </td>                </tr>                <tr>                  <td align="center">                    <%= collection_select(                          :remove,                          :name,                          @optional_cc_list,                          :id,                          :name,                          {:include_blank => true},                          "class" => 'name_select',                          "size"  => '10') %>                    <%= observe_field(                          'remove_name',                          :update => 'selections',                          :url    => {:action => 'remove_from_thread_list'},                          :with   => "'id=' + escape(value)") %>                  </td>                </tr>              </table>            <% else %>              The Optional CC list is empty.            <% end %>          </td>        </tr>      </table>    </td>  </tr>    <tr><td colspan="2"><hr class='div' /></td></tr></table></div><% if @posting_new_thread %>  <%= submit_tag "Send Email", :class => 'form_submit' %><% else %>  <%= submit_tag "Return to IPD Thread", :class => 'form_submit' %><% end %><% end %><%# debug @ipd_post %><%# debug @associated_users %><%# debug @optional_cc_list %><%# debug @available_to_cc %>